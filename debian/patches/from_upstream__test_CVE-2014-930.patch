From: =?utf-8?q?Guido_G=C3=BCnther?= <agx@sigxcpu.org>
Date: Fri, 29 May 2015 15:14:15 +0200
Subject: from_upstream__test_CVE-2014-930

---

diff --git a/tests/test-CVE-2014-9390 b/tests/test-CVE-2014-9390
new file mode 100755
index 0000000..b62dbb1
--- /dev/null
+++ b/tests/test-CVE-2014-9390
@@ -0,0 +1,65 @@
+#!/bin/sh
+#
+# Tests for CVE-2014-9390
+
+PYTHON=python
+
+# Windows short names
+echo % Tests for CVE-2014-9390
+hg init test
+cd test
+
+echo foo > foo
+hg add foo
+HGEDITOR=true hg commit -m "foo"
+
+hg rollback
+cat > evil-commit.py <<EOF
+from mercurial import ui, hg, context, node
+notrc = "HG~1/hgrc"
+u = ui.ui()
+r = hg.repository(u, '.')
+def filectxfn(repo, memctx, path):
+    return context.memfilectx(path, '[hooks]\nupdate = echo owned')
+c = context.memctx(r, [r['tip'].node(), node.nullid],
+                   'evil', [notrc], filectxfn, 0)
+r.commitctx(c)
+EOF
+$PYTHON evil-commit.py
+hg co --clean tip
+
+hg rollback
+cat > evil-commit.py <<EOF
+from mercurial import ui, hg, context, node
+notrc = "HG8B6C~2/hgrc"
+u = ui.ui()
+r = hg.repository(u, '.')
+def filectxfn(repo, memctx, path):
+    return context.memfilectx(path, '[hooks]\nupdate = echo owned')
+c = context.memctx(r, [r['tip'].node(), node.nullid],
+                   'evil', [notrc], filectxfn, 0)
+r.commitctx(c)
+EOF
+$PYTHON evil-commit.py
+hg co --clean tip
+
+# Check for codepoints ignored on OS X
+cat > evil-commit.py <<EOF
+from mercurial import ui, hg, context, node
+notrc = u".h\u200cg".encode('utf-8') + '/hgrc'
+u = ui.ui()
+r = hg.repository(u, '.')
+def filectxfn(repo, memctx, path):
+    return context.memfilectx(path, '[hooks]\nupdate = echo owned')
+c = context.memctx(r, [r['tip'].node(), node.nullid],
+                   'evil', [notrc], filectxfn, 0)
+r.commitctx(c)
+EOF
+$PYTHON evil-commit.py
+hg co --clean tip
+
+cd ..
+rm -rf test
+exit 0
+
+
diff --git a/tests/test-CVE-2014-9390.out b/tests/test-CVE-2014-9390.out
new file mode 100644
index 0000000..3004062
--- /dev/null
+++ b/tests/test-CVE-2014-9390.out
@@ -0,0 +1,6 @@
+% Tests for CVE-2014-9390
+rolling back to revision -1 (undo commit)
+abort: path contains illegal component: HG~1/hgrc
+rolling back to revision -1 (undo commit)
+abort: path contains illegal component: HG8B6C~2/hgrc
+abort: path contains illegal component: .hâ€Œg/hgrc
