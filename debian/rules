#!/usr/bin/make -f
# -*- mode: makefile; coding: utf-8 -*-

DEB_PYTHON_SYSTEM=pysupport
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk

# These part must be run between dh_install and dh_pysupport
# So, they must be defined BEFORE including python-distutils.mk
binary-install/mercurial::
	pysupport-movemodules debian/mercurial
	# remove arch-independent python stuff
	rm -rf $(CURDIR)/debian/mercurial/usr/share/python-support

binary-install/mercurial-common::
	pysupport-movemodules debian/mercurial-common
	# remove arch-dependent python stuff
	rm -rf $(CURDIR)/debian/mercurial-common/usr/lib/python-support
	rmdir --ignore-fail-on-non-empty $(CURDIR)/debian/mercurial-common/usr/lib

include /usr/share/cdbs/1/class/python-distutils.mk


binary-install/mercurial::
	# Install bash autocompletion.
	install -m 644 \
		contrib/bash_completion \
		$(CURDIR)/debian/mercurial/etc/bash_completion.d/mercurial
	
	# Install system-wide conffiles
	echo "# system-wide mercurial configuration file" \
		>  $(CURDIR)/debian/mercurial/etc/mercurial/hgrc
	echo "# See hgrc(5) for more information" \
		>>  $(CURDIR)/debian/mercurial/etc/mercurial/hgrc
	install -m 644 \
		contrib/mergetools.hgrc \
		$(CURDIR)/debian/mercurial/etc/mercurial/hgrc.d/mergetools.rc

build/mercurial:: mercurial/__version__.py

build/mercurial-common::
	$(MAKE) -C doc man
	# workaround a bug in asciidoc that generates incorrect manpages
	sed -i 's,^\([\\]\?[.]hg/hgrc\),\\\&\1,' doc/hg.1
	sed -i 's,^\([\\]\?[.][*][\\]\?[.]swp\),\\\&\1,' doc/hgignore.5

binary-install/mercurial-common::
	# web templates are symlinked from python-support to /u/s/mercurial
	rm -rf $(CURDIR)/debian/mercurial-common/usr/share/python-support/mercurial-common/mercurial/templates
	ln -sf ../../../mercurial/templates \
		$(CURDIR)/debian/mercurial-common/usr/share/python-support/mercurial-common/mercurial/templates
	
	# Examples must go in the /usr/share/doc/mercurial directory
	mv $(CURDIR)/debian/mercurial-common/usr/share/doc/mercurial-common/examples \
		$(CURDIR)/debian/mercurial-common/usr/share/doc/mercurial
	
	# Install lintian override file
	cp debian/mercurial-common.lintian-overrides \
		$(CURDIR)/debian/mercurial-common/usr/share/lintian/overrides/mercurial-common

clean::
	# Keep current mercurial version
	cp -a mercurial/__version__.py mercurial/__version__.py.save
	$(MAKE) clean
	# And retore it
	mv mercurial/__version__.py.save mercurial/__version__.py
	$(RM) -rv tmp/
	# if this is a git repository, restore removed files that would have been ignored by dpkg-source
	-test -d .git && git-checkout -- $$(git-status | \
		sed -e '/^#[[:space:]]*deleted:[[:space:]]*/s/^#[[:space:]]*deleted:[[:space:]]*//p;d' | \
		grep -v '^debian/')

mercurial/__version__.py:
	@echo "$@ is missing (you probably call 'make clean' directly)."
	@echo "Restore it from sources before building the package"
	@echo "Aborting."
	exit 1
