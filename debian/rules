#!/usr/bin/make -f
# -*- mode: makefile; coding: utf-8 -*-

# including python-distutils BEFORE debhelper.mk ...
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
include /usr/share/cdbs/1/class/python-distutils.mk
include /usr/share/cdbs/1/rules/debhelper.mk

# ... so that we can personnalize the call to dh_python
$(patsubst %,binary-install/%,$(DEB_PACKAGES)) :: binary-install/%:
	dh_python -p$(cdbs_curpkg) -V 2.4

DEB_PYTHON_COMPILE_VERSION=2.4

DEB_INSTALL_MANPAGES_mercurial=doc/hg.1 doc/hgmerge.1 doc/hgrc.5 doc/hgignore.5

common-install-impl::
	# Install bash autocompletion.
	install -d $(DEB_DESTDIR)/etc/bash_completion.d/
	install -m 644 \
		contrib/bash_completion \
		$(DEB_DESTDIR)/etc/bash_completion.d/mercurial
	#
	# Install system-wide conffile
	install -d $(DEB_DESTDIR)/etc/mercurial/
	echo "# system-wide mercurial configuration file" \
		> $(DEB_DESTDIR)/etc/mercurial/hgrc
	echo "# See hgrc(5) for more information" \
		>> $(DEB_DESTDIR)/etc/mercurial/hgrc
	#
	# Install system-wide extensions
	install -d $(DEB_DESTDIR)/etc/mercurial/hgrc.d/
	install -m 644 \
		debian/hgext.rc \
		$(DEB_DESTDIR)/etc/mercurial/hgrc.d/hgext.rc
	# Install hgk subscript
	install -d $(DEB_DESTDIR)/usr/share/mercurial
	install -m 0755 contrib/hgk $(DEB_DESTDIR)/usr/share/mercurial/hgk
	#
	# Install emacs scripts.
	install -d $(DEB_DESTDIR)/usr/share/emacs/site-lisp/ 
	install -m 0644 \
		contrib/mercurial.el \
		$(DEB_DESTDIR)/usr/share/emacs/site-lisp/
	# Move webstuff in /usr/share
	mv $(DEB_DESTDIR)/usr/lib/python2.4/site-packages/mercurial/templates \
		$(DEB_DESTDIR)/usr/share/mercurial/
	ln -sf ../../../../share/mercurial/templates \
	  $(DEB_DESTDIR)/usr/lib/python2.4/site-packages/mercurial/templates

	# fix bugs in cdbs/dh_python: mercurial will use python and not pythonX.Y
	# [update]: in fact, python2.4 is better: python2.3 does not work
	sed -i -e 's/python[0-9.]*/python2.4/' $(DEB_DESTDIR)/usr/bin/hg

build: build-doc
update-config:: link_hgit

link_hgit:
	ln -fs ../contrib/hgk.py hgext/hgk.py
	ln -fs ../contrib/purge/purge.py hgext/purge.py

build-doc:
	$(MAKE) -C doc man

clean::
	#$(MAKE) -C doc clean
	cd doc && $(RM) *.xml *.1 *.html
	$(RM) -v mercurial/*.pyc
	$(RM) -v hgext/hgk.py hgext/purge.py
	$(RM) -rfv build
