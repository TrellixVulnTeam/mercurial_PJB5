Origin: http://selenic.com/repo/hg-stable/rev/c02a05cc6f5e
Description: pathauditor: check for codepoints ignored on OS X
 This is a fix for CVE-2014-9390
Applied-Upstream: 3.2.3

--- a/mercurial/util.py
+++ b/mercurial/util.py
@@ -486,6 +486,9 @@ def copyfiles(src, dst, hardlink=None):
 
     return hardlink, num
 
+def _lowerclean(s):
+    return encoding.hfsignoreclean(s.lower())
+
 class path_auditor(object):
     '''ensure that a filesystem path contains no banned components.
     the following properties of a path are checked:
@@ -507,11 +510,11 @@ class path_auditor(object):
         normpath = os.path.normcase(path)
         parts = splitpath(normpath)
         if (os.path.splitdrive(path)[0]
-            or parts[0].lower() in ('.hg', '.hg.', '')
+            or _lowerclean(parts[0]) in ('.hg', '.hg.', '')
             or os.pardir in parts):
             raise Abort(_("path contains illegal component: %s") % path)
-        if '.hg' in path.lower():
-            lparts = [p.lower() for p in parts]
+        if '.hg' in _lowerclean(path):
+            lparts = [_lowerclean(p.lower()) for p in parts]
             for p in '.hg', '.hg.':
                 if p in lparts[1:]:
                     pos = lparts.index(p)
